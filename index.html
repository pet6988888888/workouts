<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Flow - Guided Workout Player</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app container */
        body {
            background-color: #0c0a09; /* Tailwind gray-950 */
            font-family: 'Inter', sans-serif;
        }
        #app-container {
            min-height: 100vh;
            background-color: #0c0a09;
        }
        /* Custom class for the SVG circle animation */
        .progress-circle {
            transition: stroke-dashoffset 1s linear;
        }
        /* Style for the big timer display to ensure font size consistency */
        /* Reduced by ~25% from previous sizes (4rem -> 3rem) */
        .big-timer {
            font-size: 3rem; 
        }
        /* Adjust for seconds-only display to be even bigger (6rem -> 4.5rem) */
        .big-timer.seconds-only {
            font-size: 4.5rem;
        }

        @media (min-width: 1024px) {
            /* Desktop/Large screen adjustment (8rem -> 6rem) */
            .big-timer.seconds-only {
                font-size: 6rem;
            }
        }
    </style>
</head>
<body>
    <div id="app-container" class="w-full mx-auto shadow-2xl shadow-black sm:max-w-4xl lg:max-w-7xl">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // --- Configuration Constants ---
        const CUSTOM_LOGO_URL = "https://placehold.co/64x64/4f46e5/ffffff?text=FLOW"; 
        const ICON_URLS = {
            Zap: "https://placehold.co/32x32/34d399/111827?text=ZAP",
            Bike: "https://placehold.co/32x32/60a5fa/111827?text=BIKE",
            Dumbbell: "https://placehold.co/32x32/f97316/111827?text=DB",
            Group: "https://placehold.co/32x32/059669/111827?text=GRP", 
        };

        // NOTE: A placeholder URL is used for a generic video since external assets are not portable.
        const DEMO_VIDEO_URL = "https://www.w3schools.com/html/mov_bbb.mp4";

        const WORKOUTS = [
            {
                id: 1,
                group: "Strength & Bodyweight",
                name: "Full Body Blast",
                duration: "20 min",
                icon: "Zap",
                target: "Total Body Strength",
                exercises: [
                    { 
                        name: "Squats", 
                        duration: 30, 
                        type: 'exercise', 
                        demo: "Squat form", 
                        videoUrl: "https://homeworkoutfactory.com/wp-content/uploads/2025/10/8a0a8ecc-e5a0-487b-afa5-d44f705841f3.mp4" 
                    },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null }, 
                    { name: "Push-ups", duration: 30, type: 'exercise', demo: "Chest and Triceps", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null },
                    { name: "Plank", duration: 60, type: 'exercise', demo: "Core stability", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null },
                    { name: "Lunges (per leg)", duration: 40, type: 'exercise', demo: "Lower body balance", videoUrl: DEMO_VIDEO_URL },
                ],
            },
            {
                id: 2,
                group: "Core & Mobility",
                name: "Core Crusher",
                duration: "15 min",
                icon: "Dumbbell",
                target: "Abdominal & Back",
                exercises: [
                    { name: "Crunches", duration: 45, type: 'exercise', demo: "Upper Abs", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 15, type: 'rest', videoUrl: null },
                    { name: "Leg Raises", duration: 45, type: 'exercise', demo: "Lower Abs", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 15, type: 'rest', videoUrl: null },
                    { name: "Russian Twist", duration: 45, type: 'exercise', demo: "Obliques", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 15, type: 'rest', videoUrl: null },
                    { name: "Supermans", duration: 45, type: 'exercise', demo: "Lower Back", videoUrl: DEMO_VIDEO_URL },
                ],
            },
            {
                id: 3,
                group: "Cardio",
                name: "Cardio Kickstart",
                duration: "30 min",
                icon: "Bike",
                target: "Endurance & Stamina",
                exercises: [
                    { name: "Jumping Jacks", duration: 60, type: 'exercise', demo: "Warm up", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null },
                    { name: "High Knees", duration: 60, type: 'exercise', demo: "Cardio focus", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null },
                    { name: "Mountain Climbers", duration: 45, type: 'exercise', demo: "Total body cardio", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null },
                    { name: "Burpees", duration: 30, type: 'exercise', demo: "Maximum intensity", videoUrl: DEMO_VIDEO_URL },
                ],
            },
            {
                id: 4,
                group: "Strength & Bodyweight",
                name: "Leg Day Express",
                duration: "10 min",
                icon: "Dumbbell",
                target: "Lower Body Focus",
                exercises: [
                    { name: "Wall Sit", duration: 60, type: 'exercise', demo: "Quad isometric hold", videoUrl: DEMO_VIDEO_URL },
                    { name: "Rest", duration: 10, type: 'rest', videoUrl: null },
                    { name: "Calf Raises", duration: 60, type: 'exercise', demo: "Calf strength", videoUrl: DEMO_VIDEO_URL },
                ],
            },
        ];

        // --- Global State ---
        let view = 'groupList'; // 'groupList' | 'workoutList' | 'detail' | 'player' | 'complete'
        let selectedWorkoutId = null;
        let selectedGroupName = null;
        let selectedRounds = 1; 

        // Workout Player State
        let preWorkoutCountdown = 10;
        let currentStepIndex = 0;
        let timeLeft = 0;
        let initialTime = 0;
        let isRunning = false;
        let timerInterval = null;
        let introInterval = null;
        let audioContext = null;
        let currentWorkoutSteps = []; 
        let totalTimeLeft = 0; 
        let initialTotalDuration = 0; 

        // Metrics for Completion Screen (NEW)
        let totalExerciseTime = 0; // Total active time (type: 'exercise')
        let totalRestTime = 0;     // Total rest/transition time (type: 'rest' or 'transition')


        // --- Utility Functions ---

        /** Helper to convert seconds to MM:SS format. */
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        /** * Formats the main timer.
         * Shows SS if under 60s, MM:SS otherwise. 
         */
        const formatBigTimer = (seconds) => {
            if (seconds < 60) {
                return seconds.toString().padStart(2, '0'); // Just seconds (e.g., "30")
            }
            // Use standard MM:SS format for 60 seconds or more
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        /** Initialises the AudioContext for sound effects. */
        const initAudioContext = () => {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    audioContext.resume().catch(e => console.error("Failed to resume context:", e));
                }
            } catch (e) {
                console.error("Could not initialize AudioContext:", e);
            }
        };

        /** Plays a simple sine tone. */
        const playTone = (frequency, duration = 0.1, volume = 0.5) => {
            if (!audioContext) return;

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.0001, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.warn("Audio playback failed:", e.message);
            }
        };

        /** Generates the full sequence of steps based on exercises and selected rounds. */
        const getWorkoutSteps = (exercises, rounds) => {
            let expandedSteps = [];
            let totalDuration = 0;
            let totalExerciseTime = 0; // NEW: Track active time
            let totalRestTime = 0;     // NEW: Track rest time
            const restDuration = 60; // 60s transition rest between rounds

            for (let r = 0; r < rounds; r++) {
                // Add the core exercises for the round
                expandedSteps.push(...exercises.map(step => {
                    totalDuration += step.duration;
                    if (step.type === 'exercise') {
                        totalExerciseTime += step.duration;
                    } else if (step.type === 'rest') {
                        totalRestTime += step.duration;
                    }
                    return { ...step, round: r + 1, isCore: true };
                }));
                
                // Add a transition rest if it's not the final round
                if (r < rounds - 1) {
                     expandedSteps.push({ 
                         name: `Round ${r + 1} Complete - Take a ${restDuration}s Break`, 
                         duration: restDuration, 
                         type: 'transition',
                         videoUrl: null,
                         round: r + 1,
                         isCore: false
                     });
                     totalDuration += restDuration;
                     totalRestTime += restDuration; // Track transition rest
                }
            }
            // Return all calculated metrics
            return { expandedSteps, totalDuration, totalExerciseTime, totalRestTime };
        };

        // --- Navigation and Main Renderer ---

        /** Updates the view state and re-renders the application. */
        const navigateTo = (newView, params = {}) => {
            // Clear any active intervals/timers before changing view
            if (timerInterval) clearInterval(timerInterval);
            if (introInterval) clearInterval(introInterval);
            timerInterval = null;
            introInterval = null;

            view = newView;
            if (newView === 'groupList') {
                selectedWorkoutId = null;
                selectedGroupName = null;
            } else if (newView === 'workoutList') {
                selectedGroupName = params.groupName;
            } else if (newView === 'detail') {
                selectedWorkoutId = params.workoutId;
                selectedRounds = 1; // Reset rounds when viewing details
            } else if (newView === 'player') {
                // Initialize player state
                const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
                const result = getWorkoutSteps(workout.exercises, selectedRounds);
                
                currentWorkoutSteps = result.expandedSteps; 
                initialTotalDuration = result.totalDuration; 
                totalTimeLeft = result.totalDuration; 
                
                // Store completion metrics (NEW)
                totalExerciseTime = result.totalExerciseTime;
                totalRestTime = result.totalRestTime;
                
                currentStepIndex = 0;
                preWorkoutCountdown = 10;
                timeLeft = currentWorkoutSteps[0].duration;
                initialTime = currentWorkoutSteps[0].duration;
                isRunning = false;
                initAudioContext();
            }

            renderApp();
        };

        /** Main function to render the current view */
        const renderApp = () => {
            const container = document.getElementById('app-container');
            container.innerHTML = '';

            switch (view) {
                case 'groupList':
                    renderGroupList(container);
                    break;
                case 'workoutList':
                    renderGroupWorkouts(container);
                    break;
                case 'detail':
                    renderWorkoutDetail(container);
                    break;
                case 'player':
                    renderWorkoutPlayer(container);
                    break;
                case 'complete':
                    renderCompletionScreen(container);
                    break;
                default:
                    renderGroupList(container);
            }
        };

        // --- View Implementations ---

        /** 1. Group List View (Home Screen) */
        const renderGroupList = (container) => {
            const groupsMap = WORKOUTS.reduce((acc, workout) => {
                acc[workout.group] = (acc[workout.group] || 0) + 1;
                return acc;
            }, {});
            const groups = Object.keys(groupsMap).map(name => ({ name, count: groupsMap[name] }));
            const groupIconUrl = ICON_URLS.Group;

            const html = `
                <div class="min-h-screen bg-gray-950 text-gray-100 p-4">
                    <header class="py-6 mb-8 text-center">
                        ${CUSTOM_LOGO_URL ? `
                            <img 
                                src="${CUSTOM_LOGO_URL}" 
                                alt="Custom App Logo" 
                                class="mx-auto w-16 h-16 object-contain rounded-full mb-3 shadow-lg" 
                                onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/pet6988888888/images/refs/heads/main/Screenshot_104.jpg';"
                            />
                        ` : `
                            <svg class="w-12 h-12 text-indigo-400 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 0113.414 10H12a2 2 0 00-2 2v4h4a2 2 0 002-2v-4zM7 12h4m-4 0a3 3 0 003 3v4a2 2 0 002-2v-2h-4z"/>
                            </svg>
                        `}
                        <h1 class="text-4xl font-extrabold text-white">Home Workout Factory</h1>
                        <p class="text-gray-400 mt-1">Choose a category to find your routine.</p>
                    </header>
                    
                    <div class="space-y-4" id="group-list-container">
                        <!-- Group buttons go here -->
                    </div>
                </div>
            `;
            container.innerHTML = html;

            const listContainer = document.getElementById('group-list-container');
            groups.forEach(group => {
                const button = document.createElement('button');
                button.className = "w-full text-left bg-gray-800 p-6 rounded-2xl shadow-lg border-b-4 border-emerald-600 hover:shadow-xl hover:bg-gray-700 transition-all duration-300";
                button.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-3 bg-emerald-900 rounded-lg mr-4">
                                <img src="${groupIconUrl}" alt="Group Icon" class="w-6 h-6 object-contain text-emerald-400" />
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-white">${group.name}</h2>
                                <p class="text-sm text-gray-400 mt-1">${group.count} Workouts</p>
                            </div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-500 rotate-180" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </div>
                `;
                button.addEventListener('click', () => navigateTo('workoutList', { groupName: group.name }));
                listContainer.appendChild(button);
            });
        };

        /** 2. Group Workouts List View */
        const renderGroupWorkouts = (container) => {
            const filteredWorkouts = WORKOUTS.filter(w => w.group === selectedGroupName);

            const headerHtml = `
                <div class="min-h-screen bg-gray-950 text-gray-100 p-4">
                    <header class="py-6 mb-6">
                        <div class="flex items-center justify-start mb-6">
                            <button id="back-to-groups" class="flex items-center text-indigo-400 hover:text-indigo-300 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> All Groups
                            </button>
                        </div>
                        <h1 class="text-3xl font-extrabold text-white">${selectedGroupName}</h1>
                        <p class="text-gray-400 mt-1">Select a routine from this collection.</p>
                    </header>
                    <div class="space-y-4" id="workout-list-container">
                        <!-- Workout buttons go here -->
                    </div>
                </div>
            `;
            container.innerHTML = headerHtml;

            document.getElementById('back-to-groups').addEventListener('click', () => navigateTo('groupList'));

            const listContainer = document.getElementById('workout-list-container');
            filteredWorkouts.forEach(workout => {
                const iconUrl = ICON_URLS[workout.icon];
                const button = document.createElement('button');
                button.className = "w-full text-left bg-gray-800 p-5 rounded-2xl shadow-lg border-b-4 border-indigo-600 hover:shadow-xl hover:bg-gray-700 transition-all duration-300";
                button.innerHTML = `
                    <div class="flex items-start">
                        <div class="p-3 bg-indigo-900 rounded-lg mr-4">
                            <img src="${iconUrl}" alt="${workout.icon}" class="w-6 h-6 object-contain text-indigo-400" />
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-xl font-bold text-white">${workout.name}</h2>
                            <p class="text-sm text-gray-300 mt-1">${workout.target}</p>
                            <p class="text-sm font-semibold text-indigo-400 flex items-center mt-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 text-indigo-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ${workout.duration}
                            </p>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 rotate-180" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18-6-6 6-6"/></svg>
                    </div>
                `;
                button.addEventListener('click', () => navigateTo('detail', { workoutId: workout.id }));
                listContainer.appendChild(button);
            });
        };

        /** 3. Workout Detail View */
        const renderWorkoutDetail = (container) => {
            const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
            if (!workout) return navigateTo('groupList');

            const iconUrl = ICON_URLS[workout.icon];

            // Calculate total time for one round
            const oneRoundTime = workout.exercises.reduce((sum, step) => sum + step.duration, 0);

            // Function to calculate estimated total time based on rounds (including round transition rest)
            const getEstimatedTime = (rounds) => {
                const totalExerciseTime = oneRoundTime * rounds;
                const totalTransitionRest = (rounds > 1 ? rounds - 1 : 0) * 60; // 60s rest between rounds
                return formatTime(totalExerciseTime + totalTransitionRest);
            };

            const html = `
                <div class="min-h-screen bg-gray-900 text-gray-100 flex flex-col p-4">
                    <div class="flex items-center justify-start mb-6">
                        <button id="back-to-workouts" class="flex items-center text-indigo-400 hover:text-indigo-300 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> Back to Workouts
                        </button>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl border-t-4 border-indigo-600 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <img src="${iconUrl}" alt="${workout.icon}" class="w-10 h-10 object-contain text-indigo-400" />
                            <p class="text-sm font-semibold text-gray-400 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ${getEstimatedTime(selectedRounds)} Total
                            </p>
                        </div>
                        <h1 class="text-3xl font-extrabold text-white mb-1">${workout.name}</h1>
                        <p class="text-md text-gray-300 italic">Target: ${workout.target}</p>
                        
                        <!-- Rounds Selector -->
                        <div class="mt-4 pt-4 border-t border-gray-700 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                            <label for="rounds-selector" class="text-sm font-semibold text-gray-400 mb-2 sm:mb-0">Select Rounds:</label>
                            <select id="rounds-selector" class="bg-gray-700 text-white p-2 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors cursor-pointer">
                                <option value="1">1 Round (${getEstimatedTime(1)})</option>
                                <option value="2">2 Rounds (${getEstimatedTime(2)})</option>
                                <option value="3">3 Rounds (${getEstimatedTime(3)})</option>
                                <option value="4">4 Rounds (${getEstimatedTime(4)})</option>
                                <option value="5">5 Rounds (${getEstimatedTime(5)})</option>
                            </select>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-white mb-3 border-b border-gray-700 pb-2">Exercises (Per Round)</h2>
                    <div class="space-y-3 flex-grow overflow-y-auto pb-20" id="exercise-list">
                        <!-- Exercises populated here -->
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gray-900 border-t border-gray-700 shadow-2xl shadow-black/50">
                        <button id="start-workout-btn" class="w-full bg-indigo-600 text-white p-4 rounded-xl text-xl font-bold shadow-indigo-500/50 hover:bg-indigo-700 transition-colors flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg> Start Workout
                        </button>
                    </div>
                </div>
            `;
            container.innerHTML = html;

            document.getElementById('back-to-workouts').addEventListener('click', () => navigateTo('workoutList', { groupName: workout.group }));
            
            const roundsSelector = document.getElementById('rounds-selector');
            roundsSelector.value = selectedRounds; // Set the current round value
            roundsSelector.addEventListener('change', (e) => {
                selectedRounds = parseInt(e.target.value, 10);
            });

            document.getElementById('start-workout-btn').addEventListener('click', () => {
                // Read the final rounds selection before navigation
                selectedRounds = parseInt(document.getElementById('rounds-selector').value, 10);
                navigateTo('player');
            });

            const exerciseList = document.getElementById('exercise-list');
            workout.exercises.forEach((step, index) => {
                const stepDiv = document.createElement('div');
                const isExercise = step.type === 'exercise';
                stepDiv.className = `flex justify-between items-center p-4 rounded-xl shadow-md transition-shadow ${isExercise ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-700 hover:bg-gray-600'}`;
                stepDiv.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full text-white text-xs font-bold flex items-center justify-center mr-3 ${isExercise ? 'bg-emerald-500' : 'bg-rose-500'}">
                            ${index + 1}
                        </span>
                        <div>
                            <p class="text-lg font-semibold text-white">${step.name}</p>
                            <p class="text-xs text-gray-400">${isExercise ? 'Active' : 'Rest'}</p>
                        </div>
                    </div>
                    <p class="font-bold text-gray-200">${step.duration}s</p>
                `;
                exerciseList.appendChild(stepDiv);
            });
        };

        /** 4. Workout Player View */
        const renderWorkoutPlayer = (container) => {
            const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
            if (!workout || currentWorkoutSteps.length === 0) return navigateTo('groupList');

            // --- Pre-Workout Countdown Render ---
            if (preWorkoutCountdown > 0) {
                const introHtml = `
                    <div class="min-h-screen bg-gray-950 flex flex-col items-center justify-center p-4 text-center">
                        <h1 class="text-3xl text-indigo-400 font-semibold mb-8">Get Ready for:</h1>
                        <h2 class="text-6xl font-extrabold text-white mb-12 animate-pulse transition-all duration-500">
                            ${currentWorkoutSteps[0].name}
                        </h2>
                        <div id="countdown-timer" class="text-9xl font-black text-emerald-400 transition-all duration-300">
                            ${preWorkoutCountdown}
                        </div>
                        <button id="skip-countdown-btn" class="mt-16 text-lg text-gray-400 hover:text-gray-300 underline">
                            Skip Countdown
                        </button>
                    </div>
                `;
                container.innerHTML = introHtml;
                document.getElementById('skip-countdown-btn').addEventListener('click', () => {
                    // Skip to start immediately
                    if (introInterval) clearInterval(introInterval);
                    introInterval = null;
                    preWorkoutCountdown = 0;
                    isRunning = true;
                    renderApp(); // Rerender to start the main player
                });
                
                // Start intro timer
                introInterval = setInterval(() => {
                    preWorkoutCountdown--;
                    const timerEl = document.getElementById('countdown-timer');

                    if (preWorkoutCountdown >= 1 && preWorkoutCountdown <= 3) {
                        playTone(440);
                        if(timerEl) timerEl.classList.add('scale-125');
                    } else {
                        if(timerEl) timerEl.classList.remove('scale-125');
                    }

                    if (preWorkoutCountdown <= 0) {
                        playTone(880, 0.2);
                        clearInterval(introInterval);
                        isRunning = true;
                        renderApp();
                    } else {
                        if(timerEl) timerEl.textContent = preWorkoutCountdown;
                    }
                }, 1000);
                return;
            }

            // --- Main Workout Player Render ---
            const renderPlayerUI = () => {
                const currentStep = currentWorkoutSteps[currentStepIndex];
                const isLastStep = currentStepIndex === currentWorkoutSteps.length - 1;
                const nextStep = !isLastStep ? currentWorkoutSteps[currentStepIndex + 1] : null;
                const totalSteps = currentWorkoutSteps.length;

                // Color based on step type
                let typeColorClass = 'bg-gray-700';
                if (currentStep.type === 'exercise') {
                    typeColorClass = 'bg-emerald-600';
                } else if (currentStep.type === 'rest') {
                    typeColorClass = 'bg-rose-500';
                } else if (currentStep.type === 'transition') {
                     typeColorClass = 'bg-indigo-600';
                }

                // Calculate progress for the circular timer
                const timerProgress = initialTime > 0 ? (timeLeft / initialTime) * 100 : 0;
                const circumference = 2 * Math.PI * 45;
                const dashoffset = circumference * (1 - timerProgress / 100);

                const nextUpHtml = nextStep ? `
                    <div class="mt-4 p-3 bg-gray-800 rounded-xl shadow-inner text-center border border-gray-700">
                        <p class="text-xs font-semibold uppercase text-indigo-400 tracking-wider">Up Next</p>
                        <p class="text-xl font-bold text-white mt-1">
                            ${nextStep.name} (${nextStep.duration}s)
                        </p>
                    </div>
                ` : '';
                
                const videoSourceUrl = currentStep.videoUrl || DEMO_VIDEO_URL;
                
                // Determine the current round display
                const currentRoundDisplay = currentStep.round ? 
                    (currentStep.type === 'transition' ? `Break After Round ${currentStep.round}` : `Round ${currentStep.round} of ${selectedRounds}`)
                    : 'Warmup';

                // Determine the class for the big timer display (for simplified SS display)
                const bigTimerClass = `big-timer font-black text-white ${timeLeft < 60 ? 'seconds-only' : ''}`;


                const playerHtml = `
                    <div class="min-h-screen bg-gray-900 text-gray-100 flex flex-col p-4">
                        
                        <div class="flex items-center justify-between mb-6">
                            <button id="player-back-btn" class="flex items-center text-indigo-400 hover:text-indigo-300 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg> Back
                            </button>
                            <h1 class="text-xl font-bold text-white truncate">${workout.name} (${selectedRounds} Rds)</h1>
                            
                             <!-- Total Time LEFT Display -->
                            <div class="text-right">
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Total Time Left</p>
                                <p id="total-time-display" class="text-lg font-bold text-white">${formatTime(totalTimeLeft)}</p>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col lg:grid lg:grid-cols-2 lg:gap-8">
                            
                            <div class="flex flex-col">
                                <!-- Exercise Demo Area -->
                                <div class="w-full aspect-video bg-gray-950 rounded-xl shadow-lg relative overflow-hidden">
                                    <video id="demo-video"
                                        class="absolute inset-0 w-full h-full object-cover"
                                        src="${videoSourceUrl}" 
                                        autoplay
                                        loop
                                        muted
                                        playsinline
                                    >
                                        Your browser does not support the video tag.
                                    </video>
                                </div>

                                <div id="current-step-card" class="mt-6 lg:mt-4 p-4 rounded-xl shadow-lg text-white text-center ${typeColorClass} transition-colors duration-300">
                                    <div class="text-sm font-light uppercase tracking-widest opacity-80">
                                        ${currentStep.type === 'exercise' ? 'CURRENT EXERCISE' : 'BREAK TIME'}
                                    </div>
                                    <h2 class="text-4xl font-extrabold mt-1 mb-2">${currentStep.name}</h2>
                                    <p class="text-xs font-semibold text-white/70">${currentRoundDisplay}</p>
                                </div>

                                ${nextUpHtml}
                            </div>
                            
                            <div class="flex flex-col justify-between pt-6 lg:pt-0">
                                <div class="lg:order-1">
                                    <div class="text-sm text-gray-400 flex justify-between">
                                        <span id="step-count">Step ${currentStepIndex + 1} of ${totalSteps}</span>
                                        <span id="step-type" class="font-medium uppercase">${currentStep.type}</span>
                                    </div>
                                    <div class="w-full h-2 bg-gray-700 rounded-full mt-1">
                                        <div id="overall-progress"
                                            class="h-2 rounded-full transition-all duration-700 ${typeColorClass}"
                                            style="width: ${((currentStepIndex + 1) / totalSteps) * 100}%"
                                        ></div>
                                    </div>
                                </div>

                                <div class="relative flex justify-center my-10 lg:my-0 lg:flex-1 lg:items-center lg:justify-center lg:py-8">
                                    <div class="w-56 h-56 rounded-full flex items-center justify-center relative shadow-2xl transition-all duration-300">
                                        <div class="absolute inset-0 rounded-full bg-gray-700"></div>
                                        <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                                            <circle
                                                cx="50" cy="50" r="45"
                                                fill="none"
                                                stroke-width="5"
                                                stroke-dasharray="${circumference}"
                                                stroke-dashoffset="${dashoffset}"
                                                id="timer-progress-circle"
                                                class="progress-circle ${currentStep.type === 'exercise' ? 'stroke-emerald-400' : (currentStep.type === 'rest' ? 'stroke-rose-400' : 'stroke-indigo-400')}"
                                                transform="rotate(-90 50 50)"
                                            />
                                        </svg>
                                        <p id="timer-display" class="relative ${bigTimerClass}">${formatBigTimer(timeLeft)}</p>
                                    </div>
                                </div>

                                <div class="lg:order-3 mt-auto">
                                    <div class="flex justify-around items-center p-4 bg-gray-800 rounded-xl shadow-inner shadow-black/30">
                                        <button id="play-pause-btn" class="p-4 rounded-full shadow-lg transition-all duration-300 ${isRunning ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-emerald-600 hover:bg-emerald-700'}">
                                            ${isRunning ? `
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                                            ` : `
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                            `}
                                        </button>

                                        <button id="skip-btn" class="p-4 rounded-full bg-gray-700 hover:bg-gray-600 shadow-lg ml-4 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-gray-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML = playerHtml;

                // Attach event listeners
                document.getElementById('player-back-btn').addEventListener('click', () => navigateTo('detail', { workoutId: selectedWorkoutId }));
                document.getElementById('play-pause-btn').addEventListener('click', () => {
                    isRunning = !isRunning;
                    renderPlayerUI(); // Re-render controls to update icon/color
                });
                document.getElementById('skip-btn').addEventListener('click', handleSkip);

                // Start or resume main timer
                if (isRunning && !timerInterval) {
                    timerInterval = setInterval(updateTimer, 1000);
                }
            };

            const updateTimer = () => {
                if (!isRunning) return;

                // 1. Update total time remaining
                totalTimeLeft--;
                const totalTimeDisplay = document.getElementById('total-time-display');
                if (totalTimeDisplay) totalTimeDisplay.textContent = formatTime(totalTimeLeft);

                // 2. Update current step time
                timeLeft--;

                const currentStep = currentWorkoutSteps[currentStepIndex];
                const isLastStep = currentStepIndex === currentWorkoutSteps.length - 1;
                
                // Sound effects for last 3 seconds
                if (timeLeft >= 1 && timeLeft <= 3) {
                    playTone(440);
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;

                    if (!isLastStep) {
                        playTone(880, 0.2); // Transition tone
                        currentStepIndex++;
                        const nextStep = currentWorkoutSteps[currentStepIndex];
                        timeLeft = nextStep.duration;
                        initialTime = nextStep.duration;
                        
                        // Restart timer loop immediately after updating state
                        timerInterval = setInterval(updateTimer, 1000); 

                        // Re-render UI to update all content (step name, color, video, timers)
                        renderPlayerUI(); 
                    } else {
                        // Workout Finished
                        isRunning = false;
                        playTone(330, 0.5);
                        setTimeout(() => navigateTo('complete', { workoutId: selectedWorkoutId }), 1500);
                    }
                } else {
                    // Update only the display elements
                    const timerDisplay = document.getElementById('timer-display');
                    if (timerDisplay) {
                        // Reconstruct dynamic class based on current time
                        const dynamicClass = timeLeft < 60 ? 'seconds-only' : '';
                        const staticClass = 'big-timer font-black text-white';
                        
                        // Apply the new simplified format and class
                        timerDisplay.textContent = formatBigTimer(timeLeft);
                        timerDisplay.className = `relative ${staticClass} ${dynamicClass}`;
                    }
                    
                    const timerProgressCircle = document.getElementById('timer-progress-circle');
                    if (timerProgressCircle) {
                        const progress = initialTime > 0 ? (timeLeft / initialTime) * 100 : 0;
                        const circumference = 2 * Math.PI * 45;
                        timerProgressCircle.style.strokeDashoffset = circumference * (1 - progress / 100);
                    }
                }
            };

            const handleSkip = () => {
                const isLastStep = currentStepIndex === currentWorkoutSteps.length - 1;
                if (isLastStep) {
                    return navigateTo('complete', { workoutId: selectedWorkoutId });
                }

                // Deduct remaining time from the total countdown before skipping
                totalTimeLeft -= timeLeft; 
                if (totalTimeLeft < 0) totalTimeLeft = 0;

                if (timerInterval) clearInterval(timerInterval);
                timerInterval = null;

                currentStepIndex++;
                const nextStep = currentWorkoutSteps[currentStepIndex];
                timeLeft = nextStep.duration;
                initialTime = nextStep.duration;
                isRunning = true;
                
                // Re-render to update the full UI, including the video and step names
                renderPlayerUI(); 
            };

            // Initial render call for the player
            renderPlayerUI();
        };

        /** 5. Completion Screen View */
        const renderCompletionScreen = (container) => {
            const workout = WORKOUTS.find(w => w.id === selectedWorkoutId);
            if (!workout) return navigateTo('groupList');

            // Hardcoded positive messages (NEW)
            const POSITIVE_MESSAGES = [
                "WELL DONE ON COMPLETING THE WORKOUT!",
                "YOU CRUSHED IT! WHAT A PERFORMANCE!",
                "FANTASTIC EFFORT! THAT'S ANOTHER ONE DONE.",
                "MUSCLES MADE, STRESS RELIEVED. GREAT JOB!",
                "CONSISTENCY IS KEY. KEEP UP THE AMAZING WORK!",
                "YOU DID IT! FEEL THAT ENDORPHIN RUSH!",
                "POWERFUL PERFORMANCE. YOU ARE UNSTOPPABLE!",
                "EVERY REP COUNTS. WONDERFUL JOB FINISHING!",
                "YOU EARNED THAT! CELEBRATE YOUR STRENGTH.",
                "GOALS ACHIEVED! BE PROUD OF YOUR EFFORT."
            ];
            const randomMessage = POSITIVE_MESSAGES[Math.floor(Math.random() * POSITIVE_MESSAGES.length)];

            // Retrieve stored metrics (NEW)
            const finalTimeDisplay = formatTime(initialTotalDuration);
            const activeTimeDisplay = formatTime(totalExerciseTime);
            const restTimeDisplay = formatTime(totalRestTime);


            const html = `
                <div class="min-h-screen bg-gray-950 flex flex-col items-center justify-center p-6 text-white text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-emerald-400 mb-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                    
                    <h1 class="text-4xl font-extrabold mb-8 uppercase text-emerald-400">
                        ${randomMessage}
                    </h1>

                    <p class="text-xl font-semibold mb-2 text-gray-200">${workout.name}</p>
                    
                    <!-- Metrics Breakdown (Updated to Gray Theme) -->
                    <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm shadow-xl mt-4 mb-10 border border-gray-700">
                        <h2 class="text-lg font-bold border-b border-gray-700 pb-2 mb-4 text-left text-indigo-400">Your Session Summary:</h2>
                        <div class="space-y-3 text-left">
                            <div class="flex justify-between items-center text-lg">
                                <span class="font-medium">Total Duration:</span>
                                <span class="font-bold text-emerald-400">${finalTimeDisplay}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-md text-gray-400">Time Exercising:</span>
                                <span class="font-bold">${activeTimeDisplay}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-md text-gray-400">Time Resting:</span>
                                <span class="font-bold">${restTimeDisplay}</span>
                            </div>
                            <div class="flex justify-between items-center border-t border-gray-700 pt-3 mt-3">
                                <span class="font-medium">Rounds Completed:</span>
                                <span class="text-xl font-extrabold text-emerald-400">${selectedRounds}</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="go-home-btn" class="bg-indigo-600 text-white p-4 rounded-xl text-lg font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-colors flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Go to Workouts
                    </button>
                </div>
            `;
            container.innerHTML = html;
            document.getElementById('go-home-btn').addEventListener('click', () => navigateTo('groupList'));
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderApp();
        });

    </script>
</body>

</html>
